#!bin/env php
<?php
//echo "Watcher: keep watching your changese...";
/*
$watchFile = __DIR__ . "/test.php"; // File to watch
$lastModified = filemtime($watchFile);

echo "Watching $watchFile for changes...\n";

while (true) {
    clearstatcache();
    $currentModified = filemtime($watchFile);

    if ($currentModified !== $lastModified) {
        echo "File changed, restarting script...\n";
        shell_exec("php $watchFile"); // Restart your script
        $lastModified = $currentModified;
    }

    sleep(1); // Prevent CPU overload
}*/
?>
<?php
$watchDir = __DIR__; // Change this to the directory you want to watch

// Check if inotify is available
if (!function_exists('inotify_init')) {
    die("inotify extension is not available.\n");
}

// Initialize inotify
$inotify = inotify_init();
stream_set_blocking($inotify, false);

// Watch for file modifications
$watchDescriptors = [];
$files = scandir($watchDir);
foreach ($files as $file) {
    if ($file !== "." && $file !== "..") {
        $watchDescriptors[$file] = inotify_add_watch($inotify, "$watchDir/$file", IN_MODIFY);
    }
}

echo "Watching files in: $watchDir\n";

while (true) {
    $events = inotify_read($inotify);
    if ($events) {
        echo "File change detected, restarting script...\n";
        shell_exec('php test.php'); // Restart your PHP script
    }
    sleep(1); // Avoid high CPU usage
}

inotify_rm_watch($inotify, array_values($watchDescriptors));
fclose($inotify);
?>
